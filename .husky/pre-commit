#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# TPT Asset Editor Desktop - Pre-commit Hook
# Runs code quality checks before allowing commits

echo "🔍 Running pre-commit checks..."

# Check if Node.js is available
if ! command -v node &> /dev/null; then
    echo "❌ Node.js is not installed or not in PATH"
    exit 1
fi

# Check if npm is available
if ! command -v npm &> /dev/null; then
    echo "❌ npm is not installed or not in PATH"
    exit 1
fi

# Check if ESLint is available
if ! command -v npx &> /dev/null; then
    echo "❌ npx is not available"
    exit 1
fi

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts|jsx|tsx)$' | tr '\n' ' ')

if [ -z "$STAGED_FILES" ]; then
    echo "✅ No JavaScript/TypeScript files staged for commit"
    exit 0
fi

echo "📁 Staged files: $STAGED_FILES"

# Run ESLint on staged files
echo "🔍 Running ESLint..."
npx eslint $STAGED_FILES --max-warnings 0

if [ $? -ne 0 ]; then
    echo "❌ ESLint failed. Please fix the issues and try again."
    echo "💡 You can run 'npm run lint:fix' to automatically fix some issues."
    exit 1
fi

echo "✅ ESLint passed"

# Run Prettier check on staged files
echo "🎨 Running Prettier check..."
npx prettier --check $STAGED_FILES

if [ $? -ne 0 ]; then
    echo "❌ Prettier check failed. Code formatting issues found."
    echo "💡 You can run 'npm run format' to automatically format the code."
    exit 1
fi

echo "✅ Prettier check passed"

# Optional: Run TypeScript type checking if tsconfig.json exists
if [ -f "tsconfig.json" ]; then
    echo "🔍 Running TypeScript type check..."
    npx tsc --noEmit

    if [ $? -ne 0 ]; then
        echo "❌ TypeScript type check failed. Please fix type errors."
        exit 1
    fi

    echo "✅ TypeScript type check passed"
fi

# Optional: Run tests if test script exists
if npm run test --silent 2>/dev/null; then
    echo "🧪 Running tests..."
    npm run test

    if [ $? -ne 0 ]; then
        echo "❌ Tests failed. Please fix failing tests."
        exit 1
    fi

    echo "✅ Tests passed"
else
    echo "ℹ️  No test script found, skipping tests"
fi

echo "🎉 All pre-commit checks passed! Ready to commit."
