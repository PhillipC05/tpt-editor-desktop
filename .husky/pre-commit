#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# TPT Asset Editor Desktop - Pre-commit Hook
# Runs code quality checks before allowing commits

echo "ğŸ” Running pre-commit checks..."

# Check if Node.js is available
if ! command -v node &> /dev/null; then
    echo "âŒ Node.js is not installed or not in PATH"
    exit 1
fi

# Check if npm is available
if ! command -v npm &> /dev/null; then
    echo "âŒ npm is not installed or not in PATH"
    exit 1
fi

# Check if ESLint is available
if ! command -v npx &> /dev/null; then
    echo "âŒ npx is not available"
    exit 1
fi

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts|jsx|tsx)$' | tr '\n' ' ')

if [ -z "$STAGED_FILES" ]; then
    echo "âœ… No JavaScript/TypeScript files staged for commit"
    exit 0
fi

echo "ğŸ“ Staged files: $STAGED_FILES"

# Run ESLint on staged files
echo "ğŸ” Running ESLint..."
npx eslint $STAGED_FILES --max-warnings 0

if [ $? -ne 0 ]; then
    echo "âŒ ESLint failed. Please fix the issues and try again."
    echo "ğŸ’¡ You can run 'npm run lint:fix' to automatically fix some issues."
    exit 1
fi

echo "âœ… ESLint passed"

# Run Prettier check on staged files
echo "ğŸ¨ Running Prettier check..."
npx prettier --check $STAGED_FILES

if [ $? -ne 0 ]; then
    echo "âŒ Prettier check failed. Code formatting issues found."
    echo "ğŸ’¡ You can run 'npm run format' to automatically format the code."
    exit 1
fi

echo "âœ… Prettier check passed"

# Optional: Run TypeScript type checking if tsconfig.json exists
if [ -f "tsconfig.json" ]; then
    echo "ğŸ” Running TypeScript type check..."
    npx tsc --noEmit

    if [ $? -ne 0 ]; then
        echo "âŒ TypeScript type check failed. Please fix type errors."
        exit 1
    fi

    echo "âœ… TypeScript type check passed"
fi

# Optional: Run tests if test script exists
if npm run test --silent 2>/dev/null; then
    echo "ğŸ§ª Running tests..."
    npm run test

    if [ $? -ne 0 ]; then
        echo "âŒ Tests failed. Please fix failing tests."
        exit 1
    fi

    echo "âœ… Tests passed"
else
    echo "â„¹ï¸  No test script found, skipping tests"
fi

echo "ğŸ‰ All pre-commit checks passed! Ready to commit."
